# Модуль Auth - Техническая архитектура

## 1. Назначение модуля

Модуль `auth` представляет собой изоморфное решение для аутентификации и управления пользователями в приложении OZDAO Martyrs. Модуль обеспечивает:

- **Аутентификацию пользователей** через email, телефон или Apple ID
- **Регистрацию новых пользователей** с поддержкой приглашений
- **Двухфакторную аутентификацию** (2FA) для повышения безопасности
- **Управление профилями пользователей** (CRUD операции)
- **Восстановление паролей** через email или SMS
- **Ролевую модель доступа** с поддержкой различных ролей
- **JWT-токены** для безопасной авторизации
- **Логирование посетителей** для аналитики

## 2. Архитектура взаимодействия клиент ⇄ сервер

```
┌─────────────────────────────────┐         ┌──────────────────────────────────┐
│           КЛИЕНТ (Vue)          │         │          СЕРВЕР (Express)        │
├─────────────────────────────────┤         ├──────────────────────────────────┤
│ Views/Components                │         │ Routes                           │
│ ├─ SignIn/SignUp                │◄────────┤ ├─ /api/auth/signin             │
│ ├─ Profile/ProfileEdit          │         │ ├─ /api/auth/signup              │
│ ├─ ResetPassword                │         │ ├─ /api/auth/reset-password      │
│ └─ EnterCode/EnterPassword      │         │ └─ /api/auth/update-password     │
│                                 │         │                                  │
│ Stores (State Management)       │         │ Services (Controllers)          │
│ ├─ auth.js (login/signup)       │◄────────┤ ├─ auth.service.js               │
│ ├─ twofa.js (2FA codes)        │         │ ├─ twofa.service.js              │
│ └─ users.js (CRUD operations)  │         │ └─ users.service.js              │
│                                 │         │                                  │
│ Router + Middleware             │         │ Middleware                       │
│ ├─ auth.validation.js           │         │ ├─ authJwt.js (токены)          │
│ └─ ownership.validation.js      │         │ ├─ verifySignUp.js               │
│                                 │         │ └─ verifyUser.js                 │
│                                 │         │                                  │
│ Cookie/Storage Management       │         │ Models (MongoDB)                 │
│ ├─ JWT tokens                   │         │ ├─ User                          │
│ ├─ User data                    │         │ ├─ Role                          │
│ └─ Capacitor support            │         │ └─ Visitor                       │
└─────────────────────────────────┘         └──────────────────────────────────┘
```

## 3. Точки входа и инициализация

### 3.1 Клиентская инициализация

**Файл**: `auth.client.js:34`

```javascript
function initializeAuth(app, store, router, options = {}) {
  const route = options.route || 'Home';
  
  // Регистрация локализации
  i18nManager.register('auth', locales);
  
  // Добавление маршрутов
  router.addRoute(route, routerAuth);
  router.addRoute(route, routerUsers);
  
  // Регистрация хранилищ
  store.addStore('auth', storeAuth);
  store.addStore('twofa', storeTwofa);
  store.addStore('users', storeUsers);
}
```

### 3.2 Серверная инициализация

**Файл**: `auth.server.js:12`

```javascript
function initializeAuth(app, db, origins, publicPath) {
  // Настройка моделей
  db.role = RoleModel(db);
  db.user = UserModel(db);
  db.visitor = VisitorModel(db);
  db.request = RequestModel(db);
  
  // Подключение маршрутов
  authRoutes(app, db, origins, publicPath);
  twofaRoutes(app, db, origins, publicPath);
  usersRoutes(app, db, origins, publicPath);
  
  // Логирование посетителей
  const visitorModule = visitors(db);
  app.use(visitorModule.visitorLogger);
}
```

## 4. Потоки аутентификации

### 4.1 Поток входа (Login)

```
1. Пользователь → SignIn.vue
2. Ввод email/phone + пароль
3. store/auth.js:login() → POST /api/auth/signin
4. Сервер:
   ├─ Проверка пользователя в БД
   ├─ Валидация пароля (bcrypt)
   ├─ Генерация JWT токена (10 дней)
   └─ Возврат данных пользователя + токен
5. Клиент:
   ├─ Сохранение в cookie/storage
   ├─ Установка токена в axios
   └─ GET /api/organizations/check-accesses для прав доступа
```

### 4.2 Поток регистрации (Signup)

```
1. Пользователь → SignUp.vue
2. Ввод данных + опциональный invite код
3. store/auth.js:signup() → POST /api/auth/signup
4. Сервер:
   ├─ Проверка дублирования (middleware)
   ├─ Хеширование пароля (bcrypt, salt:8)
   ├─ Создание пользователя
   ├─ Присвоение роли 'user'
   ├─ Обработка приглашения (если есть)
   └─ Генерация JWT токена
5. Клиент: как при входе
```

### 4.3 Поток 2FA и восстановления пароля

```
1. Запрос сброса → ResetPassword.vue
2. store/auth.js:resetPassword() → POST /api/auth/reset-password
3. Сервер: 
   ├─ Проверка существования пользователя
   ├─ Генерация 4-значного кода
   └─ Отправка email/SMS
4. Клиент → EnterCode.vue
5. Ввод кода → EnterPassword.vue  
6. store/auth.js:updatePassword() → POST /api/auth/update-password
7. Сервер: обновление пароля + новый JWT
```

### 4.4 Поток проверки доступов

```
1. Инициализация → store/auth.js:initialize()
2. GET /api/organizations/check-accesses (в модуле organizations!)
3. Сервер:
   ├─ Проверка JWT токена
   ├─ Поиск департаментов пользователя
   ├─ Поиск организаций в собственности
   └─ Формирование массива прав доступа
4. Клиент: сохранение в state.accesses
```

## 5. Структура файлов и их связи

### 5.1 Клиентская часть

```
views/
├── components/
│   ├── layouts/Auth.vue           # Общий layout для auth страниц
│   ├── pages/                     # Страницы аутентификации
│   │   ├── SignIn.vue            # Вход в систему
│   │   ├── SignUp.vue            # Регистрация  
│   │   ├── ResetPassword.vue     # Сброс пароля
│   │   ├── EnterCode.vue         # Ввод 2FA кода
│   │   ├── EnterPassword.vue     # Новый пароль
│   │   ├── Invite.vue            # Регистрация по приглашению
│   │   ├── Profile.vue           # Профиль пользователя
│   │   └── ProfileEdit.vue       # Редактирование профиля
│   └── sections/                  # Переиспользуемые секции
├── store/                         # Vuex-подобные хранилища
│   ├── auth.js                   # Основная аутентификация
│   ├── twofa.js                  # Двухфакторная аутентификация  
│   └── users.js                  # Управление пользователями
├── router/                        # Маршрутизация
│   ├── auth.js                   # Маршруты аутентификации
│   └── users.js                  # Маршруты пользователей
├── middlewares/                   # Валидация на клиенте
│   ├── auth.validation.js        # Проверка аутентификации
│   └── ownership.validation.js   # Проверка прав доступа
└── validations/
    └── inputs.validation.js      # Валидация форм
```

### 5.2 Серверная часть

```
controllers/
├── services/                      # Бизнес-логика
│   ├── auth.service.js           # Аутентификация
│   ├── twofa.service.js          # 2FA коды
│   └── users.service.js          # CRUD пользователей
├── routes/                        # API маршруты
│   ├── auth.routes.js            # /api/auth/*
│   ├── twofa.routes.js           # /api/twofa/*
│   └── users.routes.js           # /api/users/*
├── middlewares/                   # Серверные middleware
│   ├── authJwt.js                # JWT валидация
│   ├── verifySignUp.js           # Валидация регистрации
│   ├── verifyUser.js             # Проверка пользователей
│   └── visitor.logger.js         # Логирование посещений
└── utils/
    └── verifyAppleIdToken.js     # Apple ID интеграция
```

### 5.3 Модели данных

```
models/
├── user.model.js                 # Пользователи
├── role.model.js                 # Роли
├── visitor.model.js              # Логи посещений
└── request.model.js              # Запросы
```

## 6. API Endpoints

### 6.1 Аутентификация (/api/auth/*)

| Endpoint | Method | Middleware | Описание |
|----------|---------|------------|----------|
| `/api/auth/signin` | POST | - | Вход в систему |
| `/api/auth/signup` | POST | `checkDuplicateUsernameOrEmail` | Регистрация |
| `/api/auth/reset-password` | POST | `checkUserExist` | Сброс пароля |
| `/api/auth/update-password` | POST | - | Обновление пароля |

### 6.2 Двухфакторная аутентификация (/api/twofa/*)

| Endpoint | Method | Описание |
|----------|---------|----------|
| `/api/twofa/sendcode` | POST | Отправка кода при регистрации |
| `/api/twofa/sendcodereset` | POST | Отправка кода для сброса пароля |

### 6.3 Пользователи (/api/users/*)

| Endpoint | Method | Middleware | Описание |
|----------|---------|------------|----------|
| `/api/users` | GET | - | Получение пользователей |
| `/api/users` | POST | `verifyToken, checkDuplicateUsername` | Создание |
| `/api/users/:_id` | PUT | `verifyToken, checkDuplicateUsername` | Обновление |
| `/api/users/:_id` | DELETE | `verifyToken` | Удаление |

### 6.4 Проверка доступов

| Endpoint | Method | Middleware | Модуль | Описание |
|----------|---------|------------|---------|----------|
| `/api/organizations/check-accesses` | GET | `verifyToken` | **organizations** | Получение прав доступа |

## 7. Безопасность

### 7.1 Хеширование паролей

**Файл**: `auth.service.js:93, 164`

- Библиотека: `bcrypt`
- Salt rounds: 8
- Асинхронное хеширование при обновлении

### 7.2 JWT Токены

**Конфигурация**:
- Секретный ключ: `process.env.SECRET_KEY`
- Время жизни: 864000 секунд (10 дней)
- Содержит: `{ _id: userId, organization: orgId }`

### 7.3 Middleware безопасности

**authJwt.js**:
- `verifyToken(continueOnFail)` - проверка JWT
- Поддержка сервисных ключей (`x-service-key`)
- Извлечение токенов из headers или cookies
- Роли: `isAdmin`, `isModerator`

### 7.4 CORS и Cookie

**Настройки cookie**:
```javascript
development: { secure: false, expires: 7, sameSite: 'Lax' }
production: { 
  expires: 7, 
  domain: process.env.DOMAIN_URL, 
  sameSite: 'strict', 
  secure: true 
}
```

## 8. Интеграция в проект

### 8.1 Основная инициализация

```javascript
// Клиент
import ModuleAuth from '@martyrs/src/modules/auth/auth.client.js';
ModuleAuth.initialize(app, store, router, { route: 'Home' });

// Сервер  
import AuthModule from '@martyrs/src/modules/auth/auth.server.js';
AuthModule.initialize(app, db, origins, publicPath);
```

### 8.2 Использование в компонентах

```javascript
// Аутентификация
import * as auth from '@martyrs/src/modules/auth/views/store/auth.js';
await auth.actions.login({ email: 'user@example.com', password: '123' }, 'email');

// Управление пользователями
import * as users from '@martyrs/src/modules/auth/views/store/users.js';
const users = await users.actions.read();
```

### 8.3 Защищенные маршруты

```javascript
// Клиент
import * as authValidation from '@martyrs/src/modules/auth/views/middlewares/auth.validation.js';

{
  path: '/profile',
  beforeEnter: [authValidation.requiresAuth]
}

// Сервер
import middlewareFactory from '@martyrs/src/modules/auth/controllers/middlewares/index.js';
const { authJwt } = middlewareFactory(db);

app.get('/api/protected', [authJwt.verifyToken()], controller);
```

## 9. Расширение и конфигурация

### 9.1 Добавление новой роли

1. **База данных**:
   ```javascript
   db.role.create({ name: 'editor' })
   ```

2. **Middleware**:
   ```javascript
   const isEditor = middlewareFactory(db).authJwt.checkRole('editor');
   ```

3. **Маршрут**:
   ```javascript
   app.post('/api/content', [authJwt.verifyToken(), isEditor], controller);
   ```

### 9.2 Добавление провайдера аутентификации

1. **Сервер** (`auth.service.js`):
   ```javascript
   if (type === 'google' && authorization.id_token) {
     payload = await verifyGoogleIdToken(authorization.id_token);
     // ...
   }
   ```

2. **Клиент** (`auth.js`):
   ```javascript
   await auth.actions.login({ authorization: googleToken }, 'google');
   ```

### 9.3 Переменные окружения

```bash
SECRET_KEY=your-jwt-secret        # JWT секрет
DOMAIN_URL=example.com           # Домен для cookies  
SERVICE_KEY=service-secret       # Сервисные запросы
NODE_ENV=production             # Окружение
MOBILE_APP=true                 # Мобильное приложение
APP_NAME=MyApp                  # Название в письмах
```

### 9.4 Мобильная поддержка

Модуль поддерживает Capacitor через `@capacitor/preferences`:
- Автоматическое переключение между cookies и Capacitor storage
- Определение через `process.env.MOBILE_APP`

## 10. Ключевые сценарии использования

### 10.1 Полный цикл аутентификации

```javascript
// 1. Инициализация приложения
const cookie = await getCookie('user');
await auth.actions.initialize(cookie);

// 2. Вход пользователя
await auth.actions.login({
  email: 'user@example.com',
  password: 'password123'
}, 'email');

// 3. Проверка прав доступа происходит автоматически
// state.accesses теперь содержит права пользователя

// 4. Выход
await auth.actions.logout();
```

### 10.2 Регистрация с приглашением

```javascript
// 1. Переход по приглашению → /auth/invite?code=INVITE123
// 2. Заполнение формы
await auth.actions.signup({
  email: 'newuser@example.com',
  password: 'password123'
}, 'email', 'INVITE123');

// 3. Автоматическое создание membership в организации
```

### 10.3 Восстановление пароля

```javascript
// 1. Запрос сброса
await auth.actions.resetPassword({ email: 'user@example.com' }, 'email');

// 2. Отправка кода → state.twofa.code.isSended = true

// 3. Новый пароль
state.user.password = 'newpassword123';
state.user.passwordRepeat = 'newpassword123';
await auth.actions.updatePassword({ email: 'user@example.com' }, 'email');
```

### 10.4 Управление профилем

```javascript
// Получение данных профиля
await users.actions.read({ _id: userId });

// Обновление профиля  
await users.actions.update({
  _id: userId,
  profile: { name: 'New Name' },
  socials: { twitter: '@username' }
});
```