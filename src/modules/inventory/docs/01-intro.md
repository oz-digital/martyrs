## 1. Общее описание модуля

### Назначение и область применения

Модуль **Inventory** представляет собой комплексную систему управления складскими запасами, предназначенную для решения задач многоскладской логистики в условиях сложной продуктовой структуры. Система обеспечивает точный учет товарных остатков, автоматический расчет доступности для продажи и проактивное управление пополнением запасов.

Модуль разработан для работы в мультитенантной среде, где различные организации ведут независимый учет своих товарных запасов на множественных складских площадках.

### Ключевые сущности и их роль в системе

#### StockAvailability - Остатки и доступность для продажи

**Назначение**: Хранит фактические количества товаров на складах и вычисляемую доступность для продажи с учетом резервирований и ограничений по ингредиентам.

```javascript
{
  product: ObjectId,
  variant: ObjectId, 
  storage: ObjectId,
  quantity: Number,        // Физический остаток
  available: Number,       // Доступно для продажи
  reservations: Number,    // Зарезервировано (пока не используется)
  constraints: [{          // Ограничения по ингредиентам
    ingredient: ObjectId,  // ID ингредиента
    stock: Number,         // Остаток ингредиента на складе
    required: Number,      // Требуется на единицу товара
    available: Number      // Сколько единиц товара можно собрать
  }]
}
```

**Почему это критично**: Система поддерживает концепцию "on-demand" сборки товаров из ингредиентов. Например, пицца может быть собрана из теста, соуса и начинки. Даже если готовой пиццы нет на складе (`quantity: 0`), она может быть доступна для заказа, если есть все необходимые ингредиенты.

**Алгоритм расчета доступности**:
1. Если есть прямой остаток товара → `available = quantity`
2. Если прямого остатка нет, но есть ингредиенты → рассчитывается минимальное количество, которое можно собрать
3. Финальная доступность = min(прямой остаток, количество сборок из ингредиентов)

#### StockAdjustment - Журнал движений товаров

**Назначение**: Immutable лог всех изменений остатков товаров с полной атрибуцией и аудитом.

```javascript
{
  product: ObjectId,
  variant: ObjectId,
  storage: ObjectId,
  source: {                    // Источник изменения
    type: ['User', 'Order', 'Inventory'],
    target: ObjectId           // ID пользователя, заказа или инвентаризации
  },
  reason: ['restock', 'sale', 'return', 'damage', 'transfer', 'custom'],
  quantity: Number,            // Изменение (+/-)
  cost: Number,               // Стоимость (для учета затрат)
  comment: String
}
```

**Почему необходим отдельный журнал**: StockAvailability показывает только текущее состояние, но не объясняет, как оно возникло. StockAdjustment обеспечивает:
- **Полный аудит**: каждое изменение записывается с временной меткой и автором
- **Различение источников**: продажа vs возврат vs порча имеют разную бизнес-логику
- **Финансовый учет**: поле `cost` позволяет вести учет себестоимости товарных операций
- **Compliance**: соответствие требованиям аудита и налогового законодательства

#### StockAudit - Инвентаризация

**Назначение**: Batch-операция для проведения инвентаризации и массовой корректировки остатков.

```javascript
{
  storage: ObjectId,           // Склад, на котором проводится инвентаризация
  status: ['draft', 'published', 'cancelled'],
  positions: [{               // Массив товарных позиций
    product: ObjectId,
    variant: ObjectId,
    quantity: Number,         // Фактически насчитанное количество
    reason: String,           // Причина расхождения
    comment: String,
    cost: Number
  }],
  comment: String             // Общий комментарий к инвентаризации
}
```

**Зачем нужна batch-обработка**: Инвентаризация может затрагивать сотни товарных позиций. Создание отдельного StockAdjustment для каждой позиции привело бы к:
- Избыточности в UI (сотни форм)
- Проблемам с атомарностью (часть корректировок может не пройти)
- Сложности отката операции

StockAudit решает это через двухфазный commit:
1. **Draft фаза**: данные сохраняются, но не влияют на остатки
2. **Published фаза**: автоматически создаются соответствующие StockAdjustment и обновляются остатки в StockAvailability

#### StockAlert - Уведомления о низких остатках

**Назначение**: Конфигурация пороговых значений для автоматических уведомлений о необходимости пополнения товаров.

```javascript
{
  product: ObjectId,
  variant: ObjectId,          // null = для всех вариантов товара
  storage: ObjectId,          // null = для всех складов
  threshold: Number,          // Пороговое значение
  enabled: Boolean
}
```

**Гибкость настройки**: Система поддерживает различные уровни детализации алертов:
- **Глобальные** (`variant: null, storage: null`): для товара на всех складах
- **По складам** (`variant: null, storage: specific`): для товара на конкретном складе
- **По вариантам** (`variant: specific, storage: null`): для конкретного варианта на всех складах
- **Точечные** (`variant: specific, storage: specific`): максимальная детализация

**Проактивность**: Алерты срабатывают автоматически в момент изменения остатков, а не по расписанию, что обеспечивает оперативное реагирование на критические ситуации.

### Бизнес-проблемы, решаемые модулем

1. **Предотвращение овесселлинга**: Точный расчет доступности не позволяет продать больше товара, чем физически возможно произвести или отгрузить.

2. **Оптимизация складских запасов**: Автоматические алерты предотвращают затоваривание и дефицит.

3. **Сложная продуктовая логика**: Поддержка товаров, собираемых из ингредиентов, расширяет возможности для ресторанов, производств, кастомизации.

4. **Мультилокационность**: Управление запасами на множественных складах с централизованным контролем.

5. **Аудитируемость**: Полная история движений обеспечивает соответствие нормативным требованиям и внутреннему контролю.