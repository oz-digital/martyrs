# Проблемы с часовыми поясами в GanttChart

## Основные проблемы

### 1. Несоответствие часовых поясов между клиентом и сервером

**Проблема:**
```javascript
// Сервер возвращает дату в UTC
{
  startDate: "2024-01-15T10:00:00.000Z", // 10:00 UTC
  endDate: "2024-01-15T18:00:00.000Z"    // 18:00 UTC
}

// Клиент в Москве (UTC+3) видит:
new Date("2024-01-15T10:00:00.000Z") // 13:00 по местному времени
```

**Как ломается:**
- Событие, запланированное на 10:00 утра, отображается как 13:00
- Бары сдвигаются на количество часов разницы с UTC
- События могут "перепрыгивать" на следующий день

### 2. Переход на летнее/зимнее время

**Проблема:**
```javascript
// Март: переход на летнее время
const date1 = new Date(2024, 2, 30); // 30 марта
const date2 = new Date(2024, 2, 31); // 31 марта
// Разница может быть не 24 часа, а 23 или 25!
```

**Как ломается:**
- Неправильный расчет длительности в днях
- Сдвиг позиций баров после перехода времени
- Некорректная ширина баров

### 3. Сравнение дат без учета времени

**Проблема в коде:**
```javascript
// Текущий код (строки 301-302)
const visibleStartDay = itemStartDate < props.dateRange.start ? props.dateRange.start : itemStartDate
const visibleEndDay = itemEndDate > props.dateRange.end ? props.dateRange.end : itemEndDate
```

**Как ломается:**
- Даты с разным временем могут некорректно сравниваться
- События на границе дней могут отображаться неправильно

### 4. Использование setHours без учета часового пояса

**Проблема:**
```javascript
firstDayStart.setHours(0, 0, 0, 0) // Устанавливает 00:00 по местному времени
```

**Как ломается:**
- При работе с UTC датами это может дать неожиданный день
- Пример: `2024-01-15T23:00:00Z` в UTC+3 это уже 16 января

### 5. Расчет недель

**Проблема:**
```javascript
// Начало недели зависит от локали
weekStart.setDate(start.getDate() - start.getDay())
```

**Как ломается:**
- В разных странах неделя начинается в разные дни
- Воскресенье (США) vs Понедельник (Европа)

## Реальные сценарии поломок

### Сценарий 1: Международная команда
- Менеджер в Нью-Йорке создает задачу на 9:00 EST
- Разработчик в Москве видит её на 17:00 MSK
- В Gantt Chart задача отображается в разных днях

### Сценарий 2: Ночная смена
- Рабочая смена: 22:00 - 06:00
- Пересекает границу дня
- В дневном виде отображается некорректно

### Сценарий 3: Путешествие
- Пользователь создал событие в Москве
- Открыл приложение в Лондоне
- События сдвинулись на 3 часа

## Решения

### 1. Работа в UTC
```javascript
// Всегда конвертировать в UTC для расчетов
const startUTC = dayjs(item.startDate).utc()
const endUTC = dayjs(item.endDate).utc()

// Расчет позиций в UTC
const firstDayUTC = dayjs(visibleCells.value[0].date).utc().startOf('day')
const diffDays = endUTC.diff(firstDayUTC, 'days')
```

### 2. Нормализация дат
```javascript
// Функция для нормализации даты к началу дня в UTC
const normalizeToUTCDay = (date) => {
  return dayjs(date).utc().startOf('day').toDate()
}

// Использование
const normalizedStart = normalizeToUTCDay(startDate)
```

### 3. Явное указание часового пояса
```javascript
// В props компонента
timezone: { type: String, default: 'UTC' }

// При расчетах
const localStart = dayjs(item.startDate).tz(props.timezone)
```

### 4. Сохранение контекста времени
```javascript
// Сохранять не только дату, но и часовой пояс
{
  startDate: "2024-01-15T10:00:00.000Z",
  timezone: "Europe/Moscow",
  isAllDay: false
}
```

## Рекомендации

1. **Всегда работать в UTC** для внутренних расчетов
2. **Конвертировать в локальное время** только для отображения
3. **Использовать dayjs** с плагинами timezone и utc
4. **Тестировать** с разными часовыми поясами
5. **Документировать** в каком формате ожидаются даты

## Текущие проблемы в коде

1. Использование `new Date()` без указания часового пояса
2. Прямое сравнение дат без нормализации
3. Использование `setHours()` для установки начала дня
4. Отсутствие обработки перехода на летнее/зимнее время
5. Предположение, что день всегда 24 часа